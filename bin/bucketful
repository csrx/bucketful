#!/usr/bin/env node

var fs = require('fs');
var path = require('path');
var optimist = require('optimist');
var bucketful = require('../lib/bucketful');
var _ = require('underscore');

var argv = optimist
  .usage('Deploys websites to Amazon S3')
  .describe('bucketful:source', 'Directory to use as starting point for the upload')
  .describe('bucketful:bucket', 'S3 bucket used as target for the upload')
  .describe('bucketful:key', 'AWS access key')
  .describe('bucketful:secret', 'AWS access secret')
  .describe('bucketful:index', 'File to use as index for the site')
  .describe('bucketful:error', 'File to use for error on the site')
  .describe('bucketful:region', 'Files/folders to include in the upload')
  .describe('bucketful:dns', 'The name of a bucketful plugin for setting up a cname for your domain')
  .describe('bucketful:configs', 'The files from which to read configs')
  .describe('version', 'Print the current version number')
  .describe('help', 'Show this help message')
  .default('bucketful:index', 'index.html')
  .default('bucketful:error', 'index.html')
  .default('bucketful:configs', 'package.json;config.json')
  .alias('bucketful:region', 'region')
  .alias('bucketful:dns', 'dns')
  .alias('bucketful:configs', 'configs')
  .alias('bucketful:index', 'index')
  .alias('bucketful:error', 'error')
  .alias('bucketful:key', 'key')
  .alias('bucketful:secret', 'secret')
  .alias('bucketful:bucket', 'bucket')
  .alias('bucketful:source', 'source')
  .alias('version', 'v')
  .alias('help', 'h')
  .argv;

if (argv.help) {
  console.log(optimist.help());
  return;
}
if (argv.version) {
  console.log(require('../package.json').version);
  return;
}

process.on('uncaughtException', function() {
  console.log("uncaught exception");
  console.log(arguments);
});

var conf = bucketful.load();

bucketful.deploy(_.extend({}, conf, {
  output: process.stdout
}), function(err) {
  console.log();
  if (err) {
    console.log(err);
    process.exit(1);
  }
});
